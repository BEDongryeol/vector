sources:
  csp-web:
    type: file
    include:
      - /test/var/log/csp-was.log
    fingerprinting:
      strategy: checksum
    line_delimiter: "\n"
    multiline:
      condition_pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}'
      start_pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}'
      mode: halt_before
      timeout_ms: 10
    encoding:
      charset: utf-8

transforms:
  parse_log:
    type: remap
    inputs:
      - csp-web
    source: |
      .platform = "csp-web"
      .parsed, err = parse_regex(.message, r'^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>[A-Z]+)\s*\] (?P<pid>\d+) --- \[(?P<thread>[^\]]+)\] (?P<logger>[^\s]+)\s* : (?P<message>.+)$')
      if err != null {
        log("Error parsing log message: " + err, level: "error")
      } else {
        .level = .parsed.level
        .pid = .parsed.pid
        .thread = .parsed.thread
        .logger = .parsed.logger
        .message = .parsed.message
        }
      del(.parsed)

sinks:
  out:
    type: elasticsearch
    inputs:
      - parse_log
    api_version: v7
    endpoints:
     - "http://host.docker.internal:9200"
#    type: console
#    inputs:
#      - parse_log
#    encoding:
#      codec: json
#    batch:
#      max_bytes: 1048576  # 1MB
#      timeout_secs: 1
#    socket_keepalive: true
